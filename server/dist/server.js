!function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/",a(a.s=6)}([function(e,t){e.exports=require("node-fetch")},function(e,t){e.exports=require("pg")},function(e,t){e.exports=require("babel-polyfill")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("path")},function(e,t,a){"use strict";a.r(t);var n=a(3),r=a.n(n),o=a(4),s=a.n(o),i=(a(2),a(1));var g={PG_DB_URL:"mserverdev.cskmchbf1fd8.ap-southeast-1.rds.amazonaws.com",DB_USER:"melonade",DB_PASS:"appiansucks",DB_PORT:5432,DB_DEFAULT_DATABASE:"pt",PT_API_TOKEN:"7fd6b9475e68a6f74c2e4f376153959f",PT_BASE_URL:"https://www.pivotaltracker.com/services/v5"};var c={CONFIGURATION_TABLE:"PT_CONFIGURATION",HISTORY_TABLE:"PT_HISTORY",PT_VIEW:"PT_VIEW"};const l=new i.Pool({host:g.PG_DB_URL,port:g.DB_PORT,database:g.DB_DEFAULT_DATABASE,user:g.DB_USER,password:g.DB_PASS});l.on("connect",()=>{console.log(`Successfully connected to ${g.PG_DB_URL}, databse: ${g.DB_DEFAULT_DATABASE}`)});var u={async getLatestSprintInfo(e){const t=`SELECT * FROM ${c.HISTORY_TABLE} WHERE project_id = '${e}' ORDER BY sprint_no DESC;`;return{status:1,text:"Data retrieved!",data:(await l.query(t)).rows[0]}},async getHistory(e,t){const a=`SELECT * FROM ${c.HISTORY_TABLE} WHERE sprint_no = '${t}' AND project_id = '${e}';`;return{status:1,text:"Data retrieved!",data:(await l.query(a)).rows[0]}},async updateHistory(e){const t=`INSERT INTO public."${c.HISTORY_TABLE}"(sprint_no, project_id, sprint_start_date, release_date, review_date)\n                            VALUES('${e.sprintNo}', '${e.projectId}', '${e.sprintStartDate}', '${e.releaseDate}', '${e.reviewDate}')`;await l.query(t);return{status:1,text:"History Updated!",data:null}},async saveHistory(e){const t=`UPDATE ${c.HISTORY_TABLE} SET release_date = '${e.releaseDate}', review_date = '${e.reviewDate}' \n                            WHERE sprint_no = '${e.sprintNo}' AND project_id = '${e.projectId}'; `;console.log(t);await l.query(t);return{status:1,text:"Dates updated!",data:null}},async updateConfiguration(e){const t=`INSERT INTO ${c.CONFIGURATION_TABLE}(project_id, release_tagging, review_tagging, feature_tagging, chore_tagging, bugfix_tagging)\n                            VALUES('${e.projectId}', '${e.isReleaseTaggingEnabled}', '${e.isReviewTaggingEnabled}',\n                                                                '${e.isFeatureTaggingEnabled}', '${e.isChoreTaggingEnabled}', '${e.isBugfixTaggingEnabled}')\n                            ON CONFLICT (project_id) DO UPDATE\n                            SET (release_tagging, review_tagging, feature_tagging, chore_tagging, bugfix_tagging) = ('${e.isReleaseTaggingEnabled}', '${e.isReviewTaggingEnabled}',\n                            '${e.isFeatureTaggingEnabled}', '${e.isChoreTaggingEnabled}', '${e.isBugfixTaggingEnabled}');`;await l.query(t);return{status:1,text:"Configuration Saved!",data:null}},async getConfiguration(e){const t=`SELECT project_id, release_tagging, review_tagging, feature_tagging, chore_tagging, bugfix_tagging FROM\n                        ${c.CONFIGURATION_TABLE} WHERE project_id = '${e}'`;return{status:1,text:null,data:(await l.query(t)).rows[0]}},async getConfigurations(e){const t=`SELECT * FROM ${c.PT_VIEW} WHERE project_id = '${e}' ORDER BY sprint_no DESC;`;return{status:1,text:null,data:(await l.query(t)).rows[0]}}};var d={async getConfiguration(e,t){const a=e.params.projectId,n=await u.getConfiguration(a);t.send(n)},async saveConfiguration(e,t){const a=e.body;console.log(a);const n=await u.updateConfiguration(a);await u.saveHistory(a);t.send(n)}},p=a(0),T=a.n(p);var E=class{constructor(){this.apiKey=g.PT_DEV_API_TOKEN}async getResponseData(e,t){return T()(e,{method:t,headers:{"X-TrackerToken":this.apiKey}}).then(e=>e.json()).then(e=>e)}};var _={STORY_TYPE:{BUGFIX:"bug",FEATURE:"feature",CHORE:"chore"},EVENT_TYPE:{REVIEW:"review",RELEASE:"release"},STORY_STATE:{FINISHED:"finished",DELIVERED:"delivered",STARTED:"started",UNSTARTED:"unstarted",ACCEPTED:"accepted",REJECTED:"rejected"}};const f={async updateStory(e,t,a,n){f.tagLabel(e,t,a,n)},async getStoryById(e,t){let a=g.PT_BASE_URL;return a+="/projects/",a+=t,a+="/stories/",a+=e,await T()(a,{method:"get",headers:{"X-TrackerToken":g.PT_API_TOKEN,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>e)},getLabels:e=>e.labels,tagLabel(e,t,a,n){let r=g.PT_BASE_URL;r+="/projects/",r+=a,r+="/stories/",r+=t,r+="/labels",console.log(r);let o={name:`${f.formatDate(n)} ${e}`};T()(r,{method:"post",body:JSON.stringify(o),headers:{"X-TrackerToken":g.PT_API_TOKEN,"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{console.log(e)})},formatDate(e){let t=new Date(e),a=(t.getMonth()+1).toString(),n=t.getFullYear().toString(),r=t.getDate().toString();return`${n}-${a.padStart(2,0)}-${r.padStart(2,0)}`}};var S=f;var y=class{constructor(){this.requestUtil=new E}async getLabelsByProject(e){let t=g.PT_BASE_URL;return t+=`/projects/${e}`,t+="/labels",this.requestUtil.getResponseData(t,"get")}async getLabelByName(e,t){return t.filter(t=>t.name==e)}async tagStoryWithLabel(e,t,a,n,r){if(e==_.STORY_STATE.FINISHED||e==_.STORY_STATE.ACCEPTED){let e=!1;switch(t){case _.STORY_TYPE.FEATURE:e=r.feature_tagging;break;case _.STORY_TYPE.CHORE:e=r.chore_tagging;break;case _.STORY_TYPE.BUGFIX:e=r.bugfix_tagging}e&&r.release_tagging&&(console.log("tagging release"),await S.updateStory(_.EVENT_TYPE.RELEASE,a,n,r.release_date))}}};var R=class{constructor(){this.labelUtil=new y,this.onTrackerEvent=this.onTrackerEvent.bind(this)}async getLatestSprint(e,t){const a=e.params.projectId;let n=await u.getLatestSprintInfo(a);t.send(n)}async getConfigurations(e,t){let a=e.params.projectId,n=await u.getConfigurations(a),r=JSON.stringify(n.data);t.send(r)}async getHistoryDate(e,t){const a=e.params.projectId,n=e.params.sprintNo;let r=await u.getHistory(a,n);t.send(r)}async onTrackerEvent(e,t){const a=e.body,n=a.primary_resources[0].id,r=a.project.id;let o=a.primary_resources[0].story_type;const s=a.highlight;console.log("story type: "+o),console.log("story state: "+s);let i=await u.getConfigurations(r);await this.labelUtil.tagStoryWithLabel(s,o,n,r,i.data),t.send("request received")}};const A=new i.Pool({host:g.PG_DB_URL,port:g.DB_PORT,database:g.DB_DEFAULT_DATABASE,user:g.DB_USER,password:g.DB_PASS});A.on("connect",()=>{console.log(`Successfully connected to ${g.PG_DB_URL}`)});var b=e=>{e.use(function(e,t,a){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),a()}),e.get("/test",(e,t)=>{t.writeHead(200,{"Content-Type":"text/plain"}),t.end("Invalid Endpoint\n")}),e.get("/api/droptables",(e,t)=>{t.send("Tables dropped")}),e.get("/api/createtables",(e,t)=>{t.send("Tables created")}),e.get("/api/getsprint/project/:projectId/",(new R).getLatestSprint),e.get("/api/project/:projectId/getconfig",(new R).getConfigurations),e.get("/api/config/project/:projectId",d.getConfiguration),e.post("/api/updateconfig",d.saveConfiguration),e.post("/api/pt/hook",(new R).onTrackerEvent)},D=a(5),O=a.n(D);const v=r()(),w=process.env.PORT||5e3,h=O.a.join(__dirname,"build");v.use(s.a.urlencoded({extended:!1})),v.use(s.a.json()),v.use("/",r.a.static(h)),b(v),v.listen(w,()=>{console.log(`Serving static files from ${h}`),console.log(`Listening on port ${w}`)})}]);